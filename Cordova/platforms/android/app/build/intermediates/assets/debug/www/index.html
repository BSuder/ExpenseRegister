<!DOCTYPE html>
<html>
    <head>

		<meta name="format-detection" content="telephone=no"/>
		<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height"/>
		<meta name="msapplication-tap-highlight" content="no"/>
		<meta name="google-signin-client_id" content="25809299563-3mrkg8k5gct981flgn20dvbkld1hr8gs.apps.googleusercontent.com">
		<meta charset='utf-8' />
		
		<title>Google Sheets API Quickstart</title>

	</head>
	
	<body> 
	
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.css">
		<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
		<script src="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.js"></script>
		
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<link rel="stylesheet" href="css/TopButtonsStyle.css">
		<link rel="stylesheet" href="css/loginPageStyle.css">
		<script src="js/frontEndHelper.js"></script>
	
		<script type="text/javascript" src="cordova.js"></script>
		<script type="text/javascript" src="js/index.js"></script>
		<script src="js/firebase-3.6.4.js"></script>
		<script src="js/backend.js"></script>
			
	
		<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>

<div class="app">
</div>
	
<div data-role="page" id="loginPage"  >
		<div id="container"> 

		<div id= "title" >
			<h2 class="header">Expense Register</h2>  
		</div>
			
		<div id="buttons">
			<button onclick="Login()">Login</button> 
			<button onclick="Logout()">Logout</button> 	
		</div>
			
	</div>
	<div data-role="footer">
		<font size="2">Created by: eletele team</font>
		<font size="2">2018</font>
	</div>
	</div>
	
	<div data-role="page" id="pageone"  >
	<div data-role="header">
		<h1><font size="4">Expense Register</font></h1>
		<div  class="tile_div">
			<button onclick="genAllMain()" ><img src="img/main.png"/></button>
			<button onclick="genAllSummary()"><img src="img/summary.png"/></button>
			<button onclick="genAllHistory()"><img src="img/history.png"/></button>
			<button onclick="genAllSettings()"><img src="img/settings.png"/></button>
			<button onclick="refreshSpreadsheetList();"><img src="img/manage.png"/></button>
			<button onclick="Logout()"><img class="last" src="img/logout.png"/></button>
			<div class="clear"></div>
		</div>
		<h2 class="currentFile"><h2>
	</div>
	
	<div data-role="main" class="ui-content">
		<h2 align="center">Enter new expense</h2>

		<text>Category:</text> 
		<select id="Category" name="cat">
			<!--option value="Undefined"></option-->
		</select>
		<div><i class="fas fa-camera-retro"></i></div>
		<text>Expense title:</text>
			<input id="Title">
		<text>Amount of effort</text>
			<input id="Amount">
		<button id="submit" onclick="getNewEffort()">Submit</button>
	</div>
  
	<div data-role="footer">
		<font size="2">Created by: eletele team</font>
		<font size="2">2018</font>
	</div>

</div> 

<div data-role="page" id="Summary">
	<div data-role="header">
		<h1><font size="4">Expense Register</font></h1>
		<div  class="tile_div">
			<button onclick="genAllMain()" ><img src="img/main.png"/></button>
			<button onclick="genAllSummary()"><img src="img/summary.png"/></button>
			<button onclick="genAllHistory()"><img src="img/history.png"/></button>
			<button onclick="genAllSettings()"><img src="img/settings.png"/></button>
			<button onclick="refreshSpreadsheetList();"><img src="img/manage.png"/></button>
			<button onclick="Logout()"><img class="last" src="img/logout.png"/></button>
			<div class="clear"></div>
		</div>
		<h2 class="currentFile"><h2>
	</div>

	<div data-role="main" class="ui-content">
		<h2 align="center">Summary of efforts</h2>
		<div>
		<select id="MonthsSummary" name="summ"></select>
		<button onclick="getSelectedMonth()">Go</button>
		</div>
		<table id="MainSummary" class="greyGridTable">
		<thead>
			<tr>
				<th>Category</th>
				<th>Amount</th>
			</tr>
		</thead>
		</table>
		
		<script src="https://static.anychart.com/js/8.0.1/anychart-core.min.js"></script>
		<script src="https://static.anychart.com/js/8.0.1/anychart-pie.min.js"></script>
		<div id="MasterGraph"> 
			<div id="PieGraph"></div>
		</div>
		<table id="testTable" class="greyGridTable">
			<thead>
				<tr>
					<th>Category</th>
					<th>Amount</th>
				</tr>
			</thead>
		</table>
	</div>
  
	<div data-role="footer">
		<font size="2">Created by: eletele team</font>
		<font size="2">2018</font>
	</div>

</div> 

<div data-role="page" id="History">
	<div data-role="header">
		<h1><font size="4">Expense Register</font></h1>
		<div  class="tile_div">
			<button onclick="genAllMain()" ><img src="img/main.png"/></button>
			<button onclick="genAllSummary()"><img src="img/summary.png"/></button>
			<button onclick="genAllHistory()"><img src="img/history.png"/></button>
			<button onclick="genAllSettings()"><img src="img/settings.png"/></button>
			<button onclick="refreshSpreadsheetList();"><img src="img/manage.png"/></button>
			<button onclick="Logout()"><img class="last" src="img/logout.png"/></button>
			<div class="clear"></div>
		</div>
		<h2 class="currentFile"><h2>
	</div>
	
	<div data-role="main" class="ui-content">
		<h2 align="center">History</h2>
		<select id="MonthsSummaryHistory" name="summ"></select>
		<button onclick="getSelectedMonthHistory()">Go</button>
		
	
		<table id="historyTable" class="greyGridTable">
			<thead>
			<tr>
			<th>Category</th>
			<th>Name</th>
			<th>Value</th>
			<th>Date</th>
			</tr>
			</thead>
		</table>
	</div>

	<div data-role="footer">
		<font size="2">Created by: eletele team</font>
		<font size="2">2018</font>
	</div>

</div> 

<div data-role="page" id="Settings">
	<div data-role="header">
		<h1><font size="4">Expense Register</font></h1>
		<div  class="tile_div">
			<button onclick="genAllMain()" ><img src="img/main.png"/></button>
			<button onclick="genAllSummary()"><img src="img/summary.png"/></button>
			<button onclick="genAllHistory()"><img src="img/history.png"/></button>
			<button onclick="genAllSettings()"><img src="img/settings.png"/></button>
			<button onclick="refreshSpreadsheetList();"><img src="img/manage.png"/></button>
			<button onclick="Logout()"><img class="last" src="img/logout.png"/></button>
			<div class="clear"></div>
		</div>
		<h2 class="currentFile"><h2>
	</div>
	
	<div data-role="main" class="ui-content">
		<h2 align="center">Settings </h2>
		
		<h3 align="center">Category management</h3>

		<div>
		<table id="Categories" class="greyGridTable">
			<thead>
			<tr>
			<th>Category</th>
			<th>Type</th>
			<th></th>
			</tr>
			</thead>
		</table>
		</div>
	
		<h4 align="center">Expense limit</h4>
		<input id="balance"></input>
		<button id="saveBalance" onclick="sendBalance()">Save</button>
	</div>

	<div data-role="footer">
		<font size="2">Created by: eletele team</font>
		<font size="2">2018</font>
	</div>

</div> 

<div data-role="page" id="FilesManagement">
	<div data-role="header">
		<h1><font size="4">Expense Register</font></h1>
		<div  class="tile_div">
			<button onclick="genAllMain()" ><img src="img/main.png"/></button>
			<button onclick="genAllSummary()"><img src="img/summary.png"/></button>
			<button onclick="genAllHistory()"><img src="img/history.png"/></button>
			<button onclick="genAllSettings()"><img src="img/settings.png"/></button>
			<button onclick="refreshSpreadsheetList();"><img src="img/manage.png"/></button>
			<button onclick="Logout()"><img class="last" src="img/logout.png"/></button>
			<div class="clear"></div>
		</div>
		<h2 class="currentFile"><h2>
	</div>
	
	<div data-role="main" class="ui-content">
	
		<h2 align="center">Files management</h2>

		<div>
		<table id="FilesList" class="greyGridTable">
			<thead>
			<tr>
			<th>File Name</th>
			<th></th>
			<th></th>
			</tr>
			</thead>
		</table>
		</div>
		
	</div>

	<div data-role="footer">
		<font size="2">Created by: eletele team</font>
		<font size="2">2018</font>
	</div>

</div> 



<script>

/*************************************************  AUTHORIZATION  ***********************************************/
var CLIENT_ID = '25809299563-3mrkg8k5gct981flgn20dvbkld1hr8gs.apps.googleusercontent.com'; // Client ID and API key from the Developer Console
var API_KEY = 'AIzaSyCSq8EEMIB-9mPdyfl8oVYvGxUVjwHsRng';
var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4", "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]; // Array of API discovery doc URLs for APIs used by the quickstart
var SCOPE = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.metadata.readonly"; // Authorization scopes required by the API; multiple scopes can be included, separated by spaces.



var config = {
	apiKey: API_KEY,
	authDomain: "test1-971ad.firebaseapp.com",
	databaseURL: "https://test1-971ad.firebaseio.com",
	projectId: "test1-971ad",
	storageBucket: "test1-971ad.appspot.com",
	messagingSenderId: "289620372461"
};

var CORDOVA_LOGIN_SETUP={
    'webClientId' : CLIENT_ID,
    'scopes' : SCOPE,
    'offline': false
};


app.initialize();
firebase.initializeApp(config);

firebase.auth().onAuthStateChanged
(
	function(user)
	{
		if (user)
		{
			console.log("Firebase LOGGED IN.")
			console.log(user);
			
			
		}
		else
		{
			console.log("Firebase LOGGED OUT.")
		}
	}
);


function cordovaLoginHandler(obj)
{
	CurrentMail = obj.email.replace(/\./g,'')

    console.log("Login() OK: " + obj.displayName + ", " + obj.email);

    gapi.client.setToken({access_token: obj.accessToken});
    gapi.client.init({apiKey: API_KEY, clientId: CLIENT_ID, discoveryDocs: DISCOVERY_DOCS, scope: SCOPE});

	console.log("GAPI initialized.");
	
	UpdateCategoryLists(UpdateSheetList(generateDropDown));
	
    if(!firebase.auth().currentUser)
    {
        firebase.auth().signInWithCredential(firebase.auth.GoogleAuthProvider.credential(obj.idToken)).then
        (
            function(success)
            {
                console.log("Firebase login OK: ");
				timeout(LoadFromFirebase(CurrentMail), 3000);
                console.log(success);
            }
        )
		.catch
		(
			function(error)
			{
				console.log("Firebase login ERROR: ");
				console.log(error);
			}
		);
    }
    else
    {
        console.log("Login error: Already signed in database!");
    }
}

function Login()
{
	console.log("Login() called.");

	window.plugins.googleplus.login
	(
	    CORDOVA_LOGIN_SETUP,
        cordovaLoginHandler,
		function(msg)
		{
			console.log("Login() ERROR: ");
			console.log(msg);
		}
	);
}

function trySilentLogin()
{
	console.log("TrySilentLogin() called.");

	window.plugins.googleplus.trySilentLogin
	(
	    CORDOVA_LOGIN_SETUP,
		cordovaLoginHandler,
		function (msg)
		{
			console.log("TrySilentLogin() ERROR: ");
			console.log(msg);
		}
	);
}

function Logout()
{
	console.log("Logout() called.");

	window.plugins.googleplus.logout
	(
		function(msg)
		{
			
			console.log("Logout() OK");
			console.log(msg);
			window.location = "#loginPage";
			if(firebase.auth().currentUser)
			{
				console.log("Firebase logout..");
				firebase.auth().signOut();
				
			}
		},
		function(msg)
		{
			console.log("Logout() ERROR:");
			console.log(msg);
		}
	);
}

function SaveToFirebase(mail, spreadsheetId)
{
	console.log("Firebase SAVE for mail " + mail + " : " + spreadsheetId);
	var rootRef = firebase.database().ref().child(mail);  
	rootRef.set({'spreadsheetId' : spreadsheetId});
}

function LoadFromFirebase(mail)
{
	console.log("Loading from firebase......");

	var rootRef = firebase.database().ref().child(mail);  

	rootRef.on
	(
		'value',

		function(snapshot)
		{
			var id = snapshot.child('spreadsheetId').val();
			
			if(id == null)
			{
				console.log("FIREBASE NULL");
				window.location = "#FilesManagement";
				
				return;
			}
			
			SpreadsheetId = id;
			console.log("Firebase LOAD for mail " + mail + " : " + SpreadsheetId);
			window.location = "#mainPage";
		}
	)
}

function handleClientLoad() // On load, called to load the auth2 library and API client library.
{
    gapi.load('auth2', function () {
	    gapi.load('client', initClient);
    });
}

function initClient() // Initializes the API client library and sets up sign-in state listeners.
{
	console.log("initClient called");

	gapi.client.load("sheets", "v4",function(response) {console.log("sheets client loaded");});
	gapi.client.load('drive', 'v3', function(response) {console.log("drive client loaded");});
}

/*****************************************************************************************************************/

window.onerror = function(what, line, file)
{
	console.log("ERROR! " + what + '; ' + line + '; ' + file);
};

</script>

<script src="https://apis.google.com/js/api.js"></script>
<script>handleClientLoad();</script>


	</body>
	  	
</html>

